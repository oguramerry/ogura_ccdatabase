<!-- admin.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒªã‚³ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç®¡ç†ç”»é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .preview-area { width: 100%; height: 300px; background: #eee; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .preview-area img { max-width: 100%; max-height: 100%; }
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .preview-area.dragover { background: #e9ecef; border-color: #0d6efd; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²</h2>

    <form id="eventForm">
        <div class="mb-3">
            <label class="form-label">åˆè¨€è‘‰ (Password)</label>
            <input type="password" class="form-control" id="password" required placeholder="GASã§è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        </div>

        <hr>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆå (Title)</label>
                <input type="text" class="form-control" id="title" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
                <select class="form-select" id="category">
                    <option value="official_event">å…¬å¼ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</option>
                    <option value="official_pvp">å…¬å¼PVPæƒ…å ±</option>
                    <option value="game_event">ã‚²ãƒ¼ãƒ å†…ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</option>
                    <option value="player_event">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                    <option value="goods">ã‚°ãƒƒã‚ºç™ºå£²æƒ…å ±</option>
                    <option value="sale">ã‚»ãƒ¼ãƒ«æƒ…å ±</option>
                    <option value="seasonal">ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">é–‹å§‹æ—¥æ™‚</label>
                <input type="datetime-local" class="form-control" id="start" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">çµ‚äº†æ—¥æ™‚</label>
                <input type="datetime-local" class="form-control" id="end" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ ã¾ãŸã¯ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Ctrl+V)</label>
            <input type="file" class="form-control mb-2" id="imageInput" accept="image/*">
            
            <div class="preview-area" id="dropArea" tabindex="0">
                <span class="text-muted">ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯è²¼ã‚Šä»˜ã‘(Ctrl+V)</span>
                <img id="imagePreview" style="display:none;">
            </div>
            <div class="mt-2 text-end">
                <button type="button" class="btn btn-secondary btn-sm" id="cropBtn" style="display:none;">åˆ‡ã‚ŠæŠœãã‚’ç¢ºå®š</button>
                <button type="button" class="btn btn-danger btn-sm" id="resetBtn" style="display:none;">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">è©³ç´°URL (å…¬å¼ãƒšãƒ¼ã‚¸ãªã©)</label>
            <input type="url" class="form-control" id="url" placeholder="https://...">
        </div>

        <div class="mb-3">
            <label class="form-label">ãƒ¡ãƒ¢ (Memo)</label>
            <textarea class="form-control" id="memo" rows="3"></textarea>
        </div>

        <div class="accordion mb-3" id="gameInfoAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGameInfo">
                        ğŸ® ã‚²ãƒ¼ãƒ å†…è©³ç´° (ã‚¯ã‚¨ã‚¹ãƒˆ/å ´æ‰€/å ±é…¬ãªã©)
                    </button>
                </h2>
                <div id="collapseGameInfo" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">ã‚¯ã‚¨ã‚¹ãƒˆå</label>
                                <input type="text" class="form-control" id="quest_name">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">å—æ³¨æ¡ä»¶</label>
                                <input type="text" class="form-control" id="requirement">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">NPCå</label>
                                <input type="text" class="form-control" id="npc">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">å ´æ‰€ (X: Y:)</label>
                                <input type="text" class="form-control" id="location">
                            </div>
                            <div class="col-12 mb-2">
                                <label class="form-label">å ±é…¬è©³ç´°URL (å…¬å¼DB)</label>
                                <input type="url" class="form-control" id="reward_links">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">é‡è¦åº¦</label>
            <select class="form-select" id="priority">
                <option value="normal">æ™®é€š</option>
                <option value="high">é«˜ã„</option>
                <option value="low">ä½ã„</option>
            </select>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">ç™»éŒ²ã™ã‚‹</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw9q7AMUUGrPaJFgkcEHRNNMLHzIj7DZHDBN4NxJqSRPYMk9Vfp7TwKNwOd629So00bgA/exec"; 

    // å¤‰æ•°å®šç¾©
    const imageInput = document.getElementById('imageInput');
    const dropArea = document.getElementById('dropArea');
    const imagePreview = document.getElementById('imagePreview');
    const cropBtn = document.getElementById('cropBtn');
    const resetBtn = document.getElementById('resetBtn');
    let cropper = null;
    let croppedImageData = null; // æœ€çµ‚çš„ã«é€ä¿¡ã™ã‚‹ç”»åƒãƒ‡ãƒ¼ã‚¿

    // --- ç”»åƒå‡¦ç†é–¢é€£ ---

    // 1. ç”»åƒèª­ã¿è¾¼ã¿å‡¦ç† (å…±é€š)
    function handleImage(file) {
        if (!file.type.startsWith('image/')) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            dropArea.querySelector('span').style.display = 'none';
            resetBtn.style.display = 'inline-block';
            
            // Cropperèµ·å‹•
            if (cropper) cropper.destroy();
            cropper = new Cropper(imagePreview, {
                aspectRatio: NaN, // è‡ªç”±ãªæ¯”ç‡ (16/9ã¨ã‹å›ºå®šã—ãŸã‘ã‚Œã°ã“ã“ã‚’å¤‰ãˆã‚‹)
                viewMode: 1,
            });
            cropBtn.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    }

    // 2. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
    imageInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            handleImage(e.target.files[0]);
        }
    });

    // 3. ãƒšãƒ¼ã‚¹ãƒˆ (Ctrl+V) æ™‚
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                handleImage(file);
                e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒšãƒ¼ã‚¹ãƒˆå‹•ä½œã‚’ç„¡åŠ¹åŒ–
                break;
            }
        }
    });

    // 4. åˆ‡ã‚ŠæŠœãç¢ºå®šãƒœã‚¿ãƒ³
    cropBtn.addEventListener('click', () => {
        if (!cropper) return;
        // ãƒˆãƒªãƒŸãƒ³ã‚°ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        croppedImageData = cropper.getCroppedCanvas().toDataURL('image/jpeg');
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆ‡ã‚ŠæŠœã„ãŸç”»åƒã«å·®ã—æ›¿ãˆ
        cropper.destroy();
        cropper = null;
        imagePreview.src = croppedImageData;
        cropBtn.style.display = 'none';
        alert("ç”»åƒã‚’åˆ‡ã‚ŠæŠœãã¾ã—ãŸï¼ç™»éŒ²ãƒœã‚¿ãƒ³ã§é€ä¿¡ã•ã‚Œã¾ã™ã€‚");
    });

    // 5. ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    resetBtn.addEventListener('click', () => {
        if (cropper) cropper.destroy();
        cropper = null;
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        dropArea.querySelector('span').style.display = 'block';
        imageInput.value = '';
        cropBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        croppedImageData = null;
    });

    // --- é€ä¿¡å‡¦ç† ---

    document.getElementById('eventForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerText = "é€ä¿¡ä¸­...";

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®åé›†
        const data = {
            password: document.getElementById('password').value,
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            start: document.getElementById('start').value,
            end: document.getElementById('end').value,
            url: document.getElementById('url').value,
            memo: document.getElementById('memo').value,
            quest_name: document.getElementById('quest_name').value,
            requirement: document.getElementById('requirement').value,
            npc: document.getElementById('npc').value,
            location: document.getElementById('location').value,
            reward_links: document.getElementById('reward_links').value,
            priority: document.getElementById('priority').value,
            
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ (åˆ‡ã‚ŠæŠœãæ¸ˆã¿ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°ç©º)
            imageData: croppedImageData || null,
            imageName: 'upload_image.jpg',
            imageMimeType: 'image/jpeg'
        };

        // GASã¸é€ä¿¡
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
            'Content-Type': 'text/plain;charset=utf-8' 
        },
                body: JSON.stringify(data) // JSONæ–‡å­—åˆ—ã¨ã—ã¦é€ã‚‹
            });
           const raw = await response.text();
let result;
try {
  result = JSON.parse(raw);
} catch (e) {
  console.error("GAS response (not JSON):", raw);
  alert("GASã®è¿”ã‚Šå€¤ãŒJSONã˜ã‚ƒãªã„ã¿ãŸã„ã€‚consoleã«è¿”ã‚Šå€¤ã‚’å‡ºã—ãŸã‚ˆã€‚");
  throw e;
}


            if (result.error) {
                alert("ã‚¨ãƒ©ãƒ¼: " + result.error);
            } else {
                localStorage.removeItem(DRAFT_KEY);
                alert("ç™»éŒ²å®Œäº†ï¼ ID: " + result.id);
                // æˆåŠŸã—ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                location.reload();
            }
        } catch (error) {
            console.error(error);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "ç™»éŒ²ã™ã‚‹";
        }
    });

    // --- ä¸‹æ›¸ãä¿å­˜æ©Ÿèƒ½ (ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–) ---
    const DRAFT_KEY = 'calendar_event_draft';

    // 1. å…¥åŠ›ã—ãŸã‚‰è‡ªå‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    document.getElementById('eventForm').addEventListener('input', (e) => {
        const draftData = {
            password: document.getElementById('password').value,
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            start: document.getElementById('start').value,
            end: document.getElementById('end').value,
            url: document.getElementById('url').value,
            memo: document.getElementById('memo').value,
            quest_name: document.getElementById('quest_name').value,
            requirement: document.getElementById('requirement').value,
            npc: document.getElementById('npc').value,
            location: document.getElementById('location').value,
            reward_links: document.getElementById('reward_links').value,
            priority: document.getElementById('priority').value
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
    });

    // 2. ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«å¾©å…ƒ
    window.addEventListener('load', () => {
        const savedDraft = localStorage.getItem(DRAFT_KEY);
        if (savedDraft) {
            const data = JSON.parse(savedDraft);
            document.getElementById('password').value = data.password || '';
            document.getElementById('title').value = data.title || '';
            document.getElementById('category').value = data.category || 'official_event';
            document.getElementById('start').value = data.start || '';
            document.getElementById('end').value = data.end || '';
            document.getElementById('url').value = data.url || '';
            document.getElementById('memo').value = data.memo || '';
            document.getElementById('quest_name').value = data.quest_name || '';
            document.getElementById('requirement').value = data.requirement || '';
            document.getElementById('npc').value = data.npc || '';
            document.getElementById('location').value = data.location || '';
            document.getElementById('reward_links').value = data.reward_links || '';
            document.getElementById('priority').value = data.priority || 'normal';
        }
    });

    // 3. é€ä¿¡æˆåŠŸã—ãŸã¨ãã ã‘ä¸‹æ›¸ãã‚’å‰Šé™¤
    // â€»å…ƒã®é€ä¿¡å‡¦ç†ã® success ã®éƒ¨åˆ†ã«ä»¥ä¸‹ã®1è¡Œã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆ
    // localStorage.removeItem(DRAFT_KEY);
</script>

</body>
</html>
