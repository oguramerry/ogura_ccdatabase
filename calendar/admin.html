<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .preview-area { width: 100%; height: 300px; background: #eee; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; }
        .preview-area img { max-width: 100%; max-height: 100%; }
        .preview-area.dragover { background: #e9ecef; border-color: #0d6efd; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ç™»éŒ²</h2>

    <form id="eventForm">
        <div class="mb-3">
            <label class="form-label">åˆè¨€è‘‰ (Password)</label>
            <input type="password" class="form-control" id="password" required value="5265">
        </div>

        <hr>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆå (Title)</label>
                <input type="text" class="form-control" id="title" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
                <select class="form-select" id="category">
                    <option value="seasonal">ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                    <option value="official_pvp">å…¬å¼PVPæƒ…å ±</option>
                    <option value="official_event">å…¬å¼ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</option>
                    <option value="game_event">ã‚²ãƒ¼ãƒ å†…ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</option>
                    <option value="player_event">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                    <option value="goods">ã‚°ãƒƒã‚ºç™ºå£²æƒ…å ±</option>
                    <option value="sale">ã‚»ãƒ¼ãƒ«æƒ…å ±</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">é–‹å§‹æ—¥æ™‚</label>
                <input type="datetime-local" class="form-control" id="start" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">çµ‚äº†æ—¥æ™‚</label>
                <input type="datetime-local" class="form-control" id="end" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ ã¾ãŸã¯ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ»è²¼ã‚Šä»˜ã‘)</label>
            <input type="file" class="form-control mb-2" id="imageInput" accept="image/*">
            <div class="preview-area" id="dropArea" tabindex="0">
                <span class="text-muted">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯Ctrl+V</span>
                <img id="imagePreview" style="display:none;">
            </div>
            <div class="mt-2 text-end">
                <button type="button" class="btn btn-secondary btn-sm" id="cropBtn" style="display:none;">ç¯„å›²ã‚’ç¢ºå®š</button>
                <button type="button" class="btn btn-danger btn-sm" id="resetBtn" style="display:none;">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">è©³ç´°URL</label>
            <input type="url" class="form-control" id="url" placeholder="https://...">
        </div>

        <div class="mb-3">
            <label class="form-label">ãƒ¡ãƒ¢</label>
            <textarea class="form-control" id="memo" rows="3"></textarea>
        </div>

        <div class="accordion mb-3" id="gameInfoAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGameInfo">
                        ğŸ® ã‚²ãƒ¼ãƒ å†…è©³ç´°è¨­å®š
                    </button>
                </h2>
                <div id="collapseGameInfo" class="accordion-collapse collapse">
                    <div class="accordion-body bg-light text-dark">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">ã‚¯ã‚¨ã‚¹ãƒˆå</label>
                                <input type="text" class="form-control" id="quest_name">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">å—æ³¨æ¡ä»¶</label>
                                <input type="text" class="form-control" id="requirement">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">NPCå</label>
                                <input type="text" class="form-control" id="npc">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">å ´æ‰€ (X: Y:)</label>
                                <input type="text" class="form-control" id="location">
                            </div>
                            <div class="col-12 mb-2">
                                <label class="form-label">å ±é…¬è©³ç´°URL (å…¬å¼DB)</label>
                                <input type="url" class="form-control" id="reward_links">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">é‡è¦åº¦</label>
            <select class="form-select" id="priority">
                <option value="normal">æ™®é€š</option>
                <option value="high">é«˜ã„</option>
                <option value="low">ä½ã„</option>
            </select>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">ç™»éŒ²ã™ã‚‹</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw9q7AMUUGrPaJFgkcEHRNNMLHzIj7DZHDBN4NxJqSRPYMk9Vfp7TwKNwOd629So00bgA/exec"; 
    const DRAFT_KEY = 'calendar_event_draft';

    const imageInput = document.getElementById('imageInput');
    const dropArea = document.getElementById('dropArea');
    const imagePreview = document.getElementById('imagePreview');
    const cropBtn = document.getElementById('cropBtn');
    const resetBtn = document.getElementById('resetBtn');
    let cropper = null;
    let croppedImageData = null;

    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
        dropArea.addEventListener(name, preventDefaults, false);
    });
    ['dragenter', 'dragover'].forEach(name => {
        dropArea.addEventListener(name, () => dropArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(name => {
        dropArea.addEventListener(name, () => dropArea.classList.remove('dragover'), false);
    });
    dropArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files && files[0]) handleImage(files[0]);
    });

    function handleImage(file) {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            dropArea.querySelector('span').style.display = 'none';
            resetBtn.style.display = 'inline-block';
            if (cropper) cropper.destroy();
            cropper = new Cropper(imagePreview, { aspectRatio: NaN, viewMode: 1 });
            cropBtn.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    }

    imageInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) handleImage(e.target.files[0]);
    });

    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                handleImage(items[i].getAsFile());
                e.preventDefault();
                break;
            }
        }
    });

    cropBtn.addEventListener('click', () => {
        if (!cropper) return;
        croppedImageData = cropper.getCroppedCanvas().toDataURL('image/jpeg');
        cropper.destroy();
        cropper = null;
        imagePreview.src = croppedImageData;
        cropBtn.style.display = 'none';
    });

    resetBtn.addEventListener('click', () => {
        if (cropper) cropper.destroy();
        cropper = null;
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        dropArea.querySelector('span').style.display = 'block';
        imageInput.value = '';
        cropBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        croppedImageData = null;
    });

    document.getElementById('eventForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerText = "é€ä¿¡ä¸­...";

        if (cropper) {
            croppedImageData = cropper.getCroppedCanvas().toDataURL('image/jpeg');
        }

        const data = {
            password: document.getElementById('password').value,
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            start: document.getElementById('start').value,
            end: document.getElementById('end').value,
            url: document.getElementById('url').value,
            memo: document.getElementById('memo').value,
            quest_name: document.getElementById('quest_name').value,
            requirement: document.getElementById('requirement').value,
            npc: document.getElementById('npc').value,
            location: document.getElementById('location').value,
            reward_links: document.getElementById('reward_links').value,
            priority: document.getElementById('priority').value,
            imageData: croppedImageData || null,
            imageName: 'upload.jpg',
            imageMimeType: 'image/jpeg'
        };

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data)
            });
            const raw = await response.text();
            let result;
            try { result = JSON.parse(raw); } catch (ex) {
                console.error("GAS raw response:", raw);
                throw ex;
            }

            if (result.error) {
                alert("ã‚¨ãƒ©ãƒ¼: " + result.error);
            } else {
                localStorage.removeItem(DRAFT_KEY);
                alert("ç™»éŒ²å®Œäº†");
                location.reload();
            }
        } catch (err) {
            console.error(err);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "ç™»éŒ²ã™ã‚‹";
        }
    });

    document.getElementById('eventForm').addEventListener('input', () => {
        const draft = {
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            start: document.getElementById('start').value,
            end: document.getElementById('end').value,
            url: document.getElementById('url').value,
            memo: document.getElementById('memo').value,
            quest_name: document.getElementById('quest_name').value,
            requirement: document.getElementById('requirement').value,
            npc: document.getElementById('npc').value,
            location: document.getElementById('location').value,
            reward_links: document.getElementById('reward_links').value,
            priority: document.getElementById('priority').value
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    });

    window.addEventListener('load', () => {
        const saved = localStorage.getItem(DRAFT_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('title').value = data.title || '';
            document.getElementById('category').value = data.category || 'seasonal';
            document.getElementById('start').value = data.start || '';
            document.getElementById('end').value = data.end || '';
            document.getElementById('url').value = data.url || '';
            document.getElementById('memo').value = data.memo || '';
            document.getElementById('quest_name').value = data.quest_name || '';
            document.getElementById('requirement').value = data.requirement || '';
            document.getElementById('npc').value = data.npc || '';
            document.getElementById('location').value = data.location || '';
            document.getElementById('reward_links').value = data.reward_links || '';
            document.getElementById('priority').value = data.priority || 'normal';
        }
    });
</script>
</body>
</html>
