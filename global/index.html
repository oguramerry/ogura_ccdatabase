<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>戦場レポート</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;400;500&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../menu.js" defer></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="stage-background" class="stage-bg"></div>

  <header>
    <div class="header-inner">
      <div class="header-left">
        <h1>📊 戦場調査レポート</h1>
        <button id="refresh-btn" class="refresh-btn" title="データを更新する">↻</button>
      </div>
      <a href="../index.html" class="back-link">トップページに戻る</a>
    </div>
  </header>

  <main>
    <div class="stats-overview">
      <div class="card">
        <h3>総観測数</h3>
        <p id="total-matches">- 試合</p>
      </div>
      <div class="card">
        <h3>ステージフィルター</h3>
        <select id="stage-selector">
          <option value="ALL">全てのステージ</option>
        </select>
      </div>
    </div>

    <div class="layout-row">
      <div class="chart-card">
        <h2>所属DC分布</h2>
        <div class="chart-container">
          <canvas id="dcPieChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h2>ロール別・勝率＆人口比率</h2>
        <div class="chart-container">
          <canvas id="roleAnalysisChart"></canvas>
        </div>
      </div>
    </div>

    <div class="layout-center">
      <div class="chart-card">
        <div style="display:flex; align-items:center; gap: 15px; margin-bottom: 10px;">
          <h2 style="margin:0; border:none;">ジョブ別・勝率＆使用率（散布図）</h2>
          <div class="mini-controls" style="font-size: 0.8rem;">
            <button onclick="toggleAllJobs(true)" style="cursor:pointer; padding:2px 8px;">ALL ON</button>
            <button onclick="toggleAllJobs(false)" style="cursor:pointer; padding:2px 8px;">ALL OFF</button>
          </div>
        </div>
        
        <div id="job-scatter-icons"></div>

        <div class="chart-container auto-height">
          <canvas id="jobScatterChart"></canvas>
        </div>
      </div>
    </div>

    <div class="layout-row">
      <div class="chart-card">
        <h2>時間帯別・人口調査</h2>
        <div class="chart-container">
          <canvas id="hourChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h2 style="margin:0; border:none; padding:0;">平均与ダメージ</h2>
          <div class="toggle-group">
            <label><input type="radio" name="damageViewMode" value="ALL" checked> 全体</label>
            <label><input type="radio" name="damageViewMode" value="WIN"> 勝ち</label>
            <label><input type="radio" name="damageViewMode" value="LOSE"> 負け</label>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="damageChart"></canvas>
        </div>
      </div>
    </div>

    <div class="layout-center">
      <div class="chart-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0; border:none; padding:0;">ジョブ別・完全データリスト</h2>
          
          <div class="toggle-group method-toggle">
            <label><input type="radio" name="statMethod" value="avg" checked> 平均値</label>
            <label><input type="radio" name="statMethod" value="median"> 中央値</label>
          </div>

          <div class="toggle-group">
            <label><input type="radio" name="viewMode" value="ALL" checked> 全体</label>
            <label><input type="radio" name="viewMode" value="WIN"> 勝ち</label>
            <label><input type="radio" name="viewMode" value="LOSE"> 負け</label>
          </div>
        </div>

        <p class="table-note">※項目名をクリックすると並べ替えできます</p>
        <div class="table-responsive">
          <table id="job-stats-table">
            <thead>
              <tr>
                <th data-key="job">ジョブ(データ数)</th>
                <th data-key="winRate">勝率</th>
                <th data-key="pickRate">使用率</th>
                <th data-key="K">K</th>
                <th data-key="D">D</th>
                <th data-key="A">A</th>
                <th data-key="Damage">与ダメ</th>
                <th data-key="Taken">被ダメ</th>
                <th data-key="Heal">与ヒール</th>
                <th data-key="Time">移送時間</th>
                <th data-key="MatchTime">試合時間</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="job-detail-modal" class="modal-overlay" style="display: none;">
      <div class="modal-card">
        <div class="modal-header">
          <h2 id="modal-job-name">ジョブ名</h2>
          <button class="close-btn" onclick="closeModal()">×</button>
        </div>
        
        <div class="modal-body">
          <table class="compare-table">
            <thead>
              <tr>
                <th></th> <th>K</th> <th>D</th> <th>A</th>
                <th>与ダメージ</th> <th>被ダメージ</th> <th>与ヒール</th> <th>移送時間</th> <th>試合時間</th>
              </tr>
            </thead>
            <tbody id="modal-stats-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/ui-parts.js"></script>
  <script src="config.js"></script>
  <script src="main.js"></script>
</body>
</html>
