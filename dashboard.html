<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>dashboard</title>
  <style>
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; background:#f6fbff; }
    .wrap{ max-width: 1000px; margin: 0 auto; padding: 24px 16px; }
    .card{ background:#fff; border:1px solid #cfeaff; border-radius: 20px; padding: 18px; }
    a{ color:#1f2937; text-decoration:none; border-bottom: 1px dashed #8bd0ff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <p style="margin:0 0 12px; font-size:18px;">統計分析ページ</p>
      <div id="highlight" style="
  margin-bottom:16px;
  padding:16px;
  border-radius:20px;
  background:#ffffff;
  border:1px solid #cfeaff;
">
         <div style="
        display:flex;
        align-items:center;
        gap:10px;
        padding:12px 14px;
        border:1px solid #cfeaff;
        border-radius:999px;
        background:#f6fbff;
        max-width:360px;
      ">
        
        <span style="font-size:12px; color:#6b7280;">user</span>

        <input
            id="userInput"
            list="userList"
            type="text"
          placeholder="ユーザー名を入力…"
          style="
            border:none;
            outline:none;
            background:transparent;
            font-size:14px;
            flex:1;
          "
        />
        
        <datalist id="userList"></datalist>
      </div>
  <p style="margin:0 0 8px; font-size:14px; color:#6b7280;">
    ユーザーハイライト
  </p>
  <p style="margin:0; font-size:16px;">
    試合数 -- / 勝率 --
  </p>
</div>

      <div style="
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:12px;
  margin-top:16px;
">
  <div id="topStage" style="padding:14px; border-radius:16px; border:1px solid #cfeaff; background:#ffffff;">
    <p style="margin:0 0 6px; font-size:13px; color:#6b7280;">おすすめステージ top3</p>
    <p style="margin:0; font-size:14px;">--</p>
  </div>

  <div id="topJob" style="padding:14px; border-radius:16px; border:1px solid #cfeaff; background:#ffffff;">
    <p style="margin:0 0 6px; font-size:13px; color:#6b7280;">おすすめジョブ top3</p>
    <p style="margin:0; font-size:14px;">--</p>
  </div>

  <div id="topHour" style="padding:14px; border-radius:16px; border:1px solid #cfeaff; background:#ffffff;">
    <p style="margin:0 0 6px; font-size:13px; color:#6b7280;">おすすめ時間帯 top3</p>
    <p style="margin:0; font-size:14px;">--</p>
  </div>
</div>

       <div id="result" style="margin-top:16px; font-size:14px;"></div>

      <p style="margin:14px 0 0;">
        <a href="./index.html">トップへ戻る</a>
      </p>
    </div>
  </div>

  <script>
    console.log("mode: jsonp only");

    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("userInput");
      let timer = null;

      window.handleStatsJsonp = (data) => {
  console.log("gas stats(jsonp):", data);

  const el = document.getElementById("result");
  if (!el) return;

  const m = data.meta;
  el.textContent =
    `試合数 ${m.total} / 勝ち ${m.wins} / 負け ${m.losses} / 勝率 ${m.winRate ?? "-"}`;
        const h = document.getElementById("highlight");
if (h) {
  h.querySelector("p:last-child").textContent =
    `試合数 ${m.total} / 勝率 ${m.winRate ?? "-"}`;
}

};

      window.handleUsersJsonp = (data) => {
  console.log("gas users(jsonp):", data);

  const list = document.getElementById("userList");
  if (!list) return;

  list.innerHTML = "";

  const users = data.users || [];
  for (const u of users) {
    const opt = document.createElement("option");
    opt.value = u;
    list.appendChild(opt);
  }
};
        const sUsers = document.createElement("script");
  sUsers.src =
    "https://script.google.com/macros/s/AKfycbzC2xkZsjdr4amOc3cc0xvFLubZOfsi3G7Aw5uiqklXDJWnRKUeu6z0cwK7d144Jdi83w/exec" +
    "?action=users&callback=handleUsersJsonp" +
    "&_=" + Date.now();
  document.body.appendChild(sUsers);
    
      input.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          const user = input.value.trim();
          if (!user) return;

          const old = document.getElementById("jsonpStats");
          if (old) old.remove();

          const s = document.createElement("script");
          s.id = "jsonpStats";
          s.onload = () => console.log("jsonp script loaded");
          s.onerror = () => console.log("jsonp script load failed");

          s.src =
            "https://script.google.com/macros/s/AKfycbzC2xkZsjdr4amOc3cc0xvFLubZOfsi3G7Aw5uiqklXDJWnRKUeu6z0cwK7d144Jdi83w/exec" +
            "?action=stats&user=" + encodeURIComponent(user) +
            "&callback=handleStatsJsonp" +
            "&_=" + Date.now();

          console.log("jsonp url:", s.src);
          document.body.appendChild(s);
        }, 500);
      });
    });
  </script>
</body>
</html>
